
@{
    ViewBag.Title = "Index";
}


<h2>Contratos</h2>

<div>
    <button style="margin-right:30px;" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">Agregar</button>
</div>
<br />

<div>
    <table class="table table-striped table-dark ">
        <thead>
            <tr >
                <th scope="col">idContrato</th>
                <th scope="col">Cliente</th>
                <th scope="col">Dirección</th>
                <th scope="col">Municipio</th>
                <th scope="col">Estado</th>
                <th scope="col">FechaContrato</th>
                <th scope="col">FechaEvento</th>
                <th scope="col">Anticipo</th>
                <th scope="col">Precio</th>
                <th scope="col">Horas</th>
                <th scope="col">Estatus</th>
                <th scope="col">Acciones</th>
            </tr>
        </thead>
        <tbody id="tbody">
        </tbody>
    </table>
</div>
<!-- Modal INSERT -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5 text-dark" id="exampleModalLabel">Agregar</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body text-dark">
                @*<input id="idCli" class="form-control" type="text" placeholder="idCliente" aria-label="default input example"><br />*@
                <select id="idCli" class="form-select form-select-sm" aria-label="Small select example">
                    
                </select>
                <div class="input-group mb-3">
                </div>

                <input id="idDir" class="form-control" type="text" placeholder="idDirección" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <input id="idMun" class="form-control" type="text" placeholder="idMunicipio" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <input id="idEst" class="form-control" type="text" placeholder="idEstado" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <input id="Fco" class="form-control" type="text" placeholder="FechaContrato" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <input id="Fev" class="form-control" type="text" placeholder="FechaEvento" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <input id="Ant" class="form-control" type="text" placeholder="Anticipo" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <input id="Pre" class="form-control" type="text" placeholder="Precio" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <input id="Hor" class="form-control" type="text" placeholder="Horas" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <input id="Est" class="form-control" type="text" placeholder="Estatus" aria-label="default input example"><br />
                <div class="input-group mb-3">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" onclick="insertContrato()" class="btn btn-primary">Guardar</button>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Modal UPDATE -->

<div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5 text-dark" id="exampleModalLabel">Actualizar Contrato</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-dark">
                <div class="m-2">
                    <p class="m-0">Id:</p>
                    <input id="idCoU" class="form-control" type="text" placeholder="Id" aria-label="default input example" readonly>

                    
                </div>
                <div class="m-2">
                    <p class="m-0">idCliente:</p>
                   @* <input id="idCU" class="form-control" type="text" placeholder="idCliente" aria-label="default input example">*@
                <select id="idCU" class="form-select form-select-sm" aria-label="Small select example">
                </select>
                </div>
                <div class="m-2">
                    <p class="m-0">idDirección:</p>
                    @*<input id="idDU" class="form-control" type="text" placeholder="idDirección" aria-label="default input example">*@
                <select id="idDU" class="form-select form-select-sm" aria-label="Small select example">
                </select>
                </div>
                <div class="m-2">
                    <p class="m-0">idMunicipio:</p>
                    <input id="idMU" class="form-control" type="text" placeholder="idMunicipio" aria-label="default input example">
                </div>
                <div class="m-2">
                    <p class="m-0">idEstado:</p>
                    <input id="idEU" class="form-control" type="text" placeholder="idEstado" aria-label="default input example">
                </div>
                <div class="m-2">
                    <p class="m-0">FechaContrato:</p>
                    <input id="FcoU" class="form-control" type="text" placeholder="FechaContrato" aria-label="default input example">
                </div>
                <div class="m-2">
                    <p class="m-0">FechaEvento:</p>
                    <input id="FevU" class="form-control" type="text" placeholder="FechaEvento" aria-label="default input example">
                </div>
                <div class="m-2">
                    <p class="m-0">Anticipo:</p>
                    <input id="AntU" class="form-control" type="text" placeholder="Anticipo" aria-label="default input example">
                </div>
                <div class="m-2">
                    <p class="m-0">Precio:</p>
                    <input id="PreU" class="form-control" type="text" placeholder="Precio" aria-label="default input example">
                </div>
                <div class="m-2">
                    <p class="m-0">Horas:</p>
                    <input id="HorU" class="form-control" type="text" placeholder="Horas" aria-label="default input example">
                </div>
                <div class="m-2">
                    <p class="m-0">Estatus:</p>
                    <input id="EstU" class="form-control" type="text" placeholder="Estatus" aria-label="default input example">
                </div>


                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" onclick="actualizar()" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

    var rest;
    const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0
    })

 $(document).ready(function () {
     createtable();
     SelectCliente();
 });

    function SelectCliente(){
$.ajax({
    url: '@Url.Action("Select", "Clientes")',
    type: "POST",
    data: {},
    dataType: "json",
    success: function (d) {
        var len = d.length;

        $("#idCli").empty();
        $("#idCli").append("<option selected>Selecciona el cliente</option>");
        for (var i = 0; i < len; i++) {
            var id = d[i].idCliente;
            var name = d[i].Nombre;

            $("#idCli").append("<option value='" + id + "'>" + name + "</option>");

        }
    },
    error: function (d) {
        alert('Error de validacion. '+ d);
    }
});
}

 function createtable() {
 $.ajax({
     url: '@Url.Action("Select", "Contratos")',
     type: "POST",
     data: { },
     dataType: "json",
     success: function (d) {
         var count = d.length;
         rest = d;
         $('#tbody').empty();
         for(i = 0; i < count; i++) {
             var contenido = '<tr>';
             contenido += '<td>' + d[i].idContrato + '</td>';
             contenido += '<td>' + d[i].idCliente +'</td>';
             contenido += '<td>' + d[i].idDirección +'</td>';
             contenido += '<td>' + d[i].idMunicipio +'</td>';
             contenido += '<td>' + d[i].idEstado + '</td>';
             contenido += '<td>' + d[i].FechaContrato + '</td>';
             contenido += '<td>' + d[i].FechaEvento + '</td>';
             contenido += '<td>' + formatter.format(d[i].Anticipo) + '</td>';
             contenido += '<td>' + formatter.format(d[i].Precio) + '</td>';
             contenido += '<td>' + d[i].Horas + '</td>';
             contenido += '<td>' + d[i].Estatus + '</td>';
             contenido += '<td><button style="margin-right:30px;" class="btn btn-danger" onclick="Delete(' + d[i].idContrato + ')">Eliminar</button><button style="margin-right:30px;" class="btn btn-warning" onclick="showModal_(' + i + ')">Editar</button></td>';
              contenido += '</tr>';
              $('#tbody').append(contenido);
          }
     },
     error: function (d) {
         alert('Error de validacion. '+ d);
     }
 });

    };
       function Delete(id){
    $.ajax({
        url: '@Url.Action("delete", "Contratos")',
        type: "POST",
        data: { Id: id },
        dataType: "json",
        success: function (d) {
            if (d=="OK") {
                alert('Contrato borrado');
                createtable();
            }
        },
        error: function (d) {
            alert('Error de validacion. '+ d);
        }
    });
    }
 function insertContrato() {
     var idcliente = $('#idCli').val();
     var iddirección = $('#idDir').val();
     var idmunicipio = $('#idMun').val();
     var idestado = $('#idEst').val();
     var fechacontrato = $('#Fco').val();
     var fechaevento = $('#Fev').val();
     var anticipo = $('#Ant').val();
     var precio = $('#Pre').val();
     var horas = $('#Hor').val();
     var estatus = $('#Est').val();


    $.ajax({
        url: '@Url.Action("Insert", "Contratos")',
        type: "POST",
        data: {idCliente: idcliente, idDirección: iddirección, idMunicipio: idmunicipio, idEstado: idestado, FechaContrato: fechacontrato, FechaEvento: fechaevento, Anticipo: anticipo, Precio: precio, Horas: horas, Estatus: estatus},
        dataType: "json",
        success: function (d) {
            if (d == "OK") {
                $("#exampleModal").modal('hide')
                alert('Contrato guardado.');
                createtable();
            }
        },
        error: function (d) {
            alert('Error de validacion. ' + d);
        }
    });
    }

        function UpdateCliente(name1){
$.ajax({
    url: '@Url.Action("Select", "Clientes")',
    type: "POST",
    data: {},
    dataType: "json",
    success: function (d) {
        var len = d.length;

        $("#idCU").empty();
        //$("#idCli").append("<option selected>Selecciona el cliente</option>");
        for (var i = 0; i < len; i++) {
            var id = d[i].idCliente;
            var name = d[i].Nombre;

            if (name == name1) {
                $("#idCU").append("<option selected value='" + id + "'>" + name + "</option>");
            } else {
                $("#idCU").append("<option value='" + id + "'>" + name + "</option>");
            }
        }
    },
    error: function (d) {
        alert('Error de validacion. '+ d);
    }
});
    }

            function UpdateDireccion(name1){
$.ajax({
    url: '@Url.Action("Select", "Dirección")',
    type: "POST",
    data: {},
    dataType: "json",
    success: function (d) {
        var len = d.length;

        $("#idDU").empty();
        for (var i = 0; i < len; i++) {
            var id = d[i].idDirección;
            var name = d[i].Calle;

            if (name == name1) {
                $("#idDU").append("<option selected value='" + id + "'>" + name + "</option>");
            } else {
                $("#idDU").append("<option value='" + id + "'>" + name + "</option>");
            }
        }
    },
    error: function (d) {
        alert('Error de validacion. '+ d);
    }
});
}

 function showModal(ID) {
     $.ajax({
         url: '@Url.Action("GetById", "Contratos")',
         type: "POST",
         data: { ID: ID},
         dataType: "json",
         success: function (d) {
             //$('#clientidI').val(d.idCliente);
             $('#idCli').val(d.idCliente);
             $('#idDir').val(d.idDirección);
             $('#idMun').val(d.idMunicipio);
             $('#idEst').val(d.idEstado);
             $('#Fco').val(d.FechaContrato);
             $('#Fev').val(d.FechaEvento);
             $('#Ant').val(d.Anticipo);
             $('#Pre').val(d.Precio);
             $('#Hor').val(d.Horas);
             $('#Est').val(d.Estatus);
             $("#exampleModal").modal("show");
         },
         error: function (d) {
             alert('Error de validacion. ' + d);
         }
     });
    };
    function updateContrato() {
     var ID = $('#idCoU').val();
     var idcliente = $('#idCU').val();
     var iddirección = $('#idDU').val();
     var idmunicipio = $('#idMU').val();
     var idestado = $('#idEU').val();
     var fechacontrato = $('#FcoU').val();
     var fechaevento = $('#FevU').val();
     var anticipo = $('#AntU').val();
     var precio = $('#PreU').val();
     var horas = $('#HorU').val();
     var estatus = $('#EstU').val();

  $.ajax({
      url: '@Url.Action("Update", "Contratos")',
      type: "POST",
      data: {
          idContrato: ID, idCliente: idcliente, idDirección: iddirección, idMunicipio: idmunicipio, idEstado: idestado,
          FechaContrato: fechacontrato, FechaEvento: fechaevento, Anticipo: anticipo, Precio: precio, Horas: horas, Estatus: estatus
      },
      dataType: "json",
      success: function (d) {
          if (d == "OK") {
              alert('Contrato actualizado.');
              location.reload();
          }
      },
      error: function (d) {
          alert('Error de validacion. ' + d);
      }
  });
    }
        function actualizar() {
      var nombre = $('#NomU').val()
      if (nombre == "") {
          alert("El campo Nombre no puede estar vacío")

          return
      }

       $.ajax({
          url: '@Url.Action("Update", "Contratos")',
          type: "POST",
           data: {
               idContrato: $('#idCoU').val(), idCliente: $('#idCU').val(), idDirección: $('#idDU').val(), idMunicipio: $('#idMU').val(), idEstado: $('#idEU').val(),
               FechaContrato: $('#FcoU').val(), FechaEvento: $('#FevU').val(), Anticipo: $('#AntU').val(), Precio: $('#PreU').val(), Horas: $('#HorU').val(), Estatus: $('#EstU').val()
           },
          dataType: "json",
           success: function (d) {
               $("#exampleModal2").modal('hide')
              alert("Contrato actualizado")
              createtable();

          },
          error: function (d) {
              alert('Error de validacion. ' + d);
          }
      });
    }
    function showModal_(i) {
        $('#idCoU').val(rest[i].idContrato);
        //$('#idCU').val(rest[i].idCliente);
        UpdateCliente(rest[i].idCliente);
        //$('#idDU').val(rest[i].idDirección);
        UpdateDireccion(rest[i].idDirección);
        $('#idMU').val(rest[i].idMunicipio);
        $('#idEU').val(rest[i].idEstado);
        $('#FcoU').val(rest[i].FechaContrato);
        $('#FevU').val(rest[i].FechaEvento);
        $('#AntU').val(rest[i].Anticipo);
        $('#PreU').val(rest[i].Precio);
        $('#HorU').val(rest[i].Horas,);
        $('#EstU').val(rest[i].Estatus);
        $("#exampleModal2").modal("show");
    };
</script>